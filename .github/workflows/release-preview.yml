name: Release Preview

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    tags:
      - 'v*.*.*-preview'
  workflow_dispatch:
    inputs:
      version:
        description: 'Preview version (e.g., 0.2.0-preview)'
        required: true
        type: string

permissions:
  contents: write

env:
  NODE_VERSION: '22'

jobs:
  create-release:
    name: Create Preview Release
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create-release.outputs.result }}
      version: ${{ steps.get_version.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag or input
        id: get_version
        env:
          HEAD_REF: ${{ github.event.workflow_run.head_branch }}
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${HEAD_REF#v}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        id: create-release
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `v${{ steps.get_version.outputs.VERSION }}`,
              name: `SpecFlux Preview v${{ steps.get_version.outputs.VERSION }}`,
              body: `## SpecFlux Preview Release

            This is a **preview build** for testing new features against the staging environment.

            ### Installation

            **macOS Apple Silicon (M1/M2/M3/M4):** Download \`SpecFlux-Preview_${{ steps.get_version.outputs.VERSION }}_aarch64.dmg\`

            > **Note:** This preview build connects to the staging backend. It can be installed alongside the production app.

            > **Security Warning:** macOS may show a warning for unsigned apps. Right-click the app → Open → Open anyway.`,
              draft: true,
              prerelease: true
            });
            return data.id

  build-preview:
    name: Build Preview (macOS-arm64)
    needs: [create-release]
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Install npm dependencies
        run: npm ci

      - name: Generate API Client
        run: npm run generate:client

      - name: Build Tauri Preview app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VITE_ENV_NAME: staging
          VITE_APP_VARIANT: preview
          VITE_STAGING_API_BASE_URL: ${{ secrets.STAGING_API_BASE_URL }}
          VITE_STAGING_FIREBASE_API_KEY: ${{ secrets.STAGING_FIREBASE_API_KEY }}
          VITE_STAGING_FIREBASE_AUTH_DOMAIN: ${{ secrets.STAGING_FIREBASE_AUTH_DOMAIN }}
          VITE_STAGING_FIREBASE_PROJECT_ID: ${{ secrets.STAGING_FIREBASE_PROJECT_ID }}
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: --target aarch64-apple-darwin --config src-tauri/tauri.preview.conf.json

  publish-release:
    name: Publish Preview Release
    needs: [create-release, build-preview]
    runs-on: ubuntu-latest
    steps:
      - name: Publish Release
        uses: actions/github-script@v7
        env:
          release_id: ${{ needs.create-release.outputs.release_id }}
        with:
          script: |
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: process.env.release_id,
              draft: false
            });
